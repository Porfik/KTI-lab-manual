# Установка гипервизора и создание виртуальных машин
1. [Настройка гипервизора](#настройка-гипервизора)
2. [Установка виртуальной машины](#установка-виртуальной-машины)
	1. [Создание новой ВМ](#создание-новой-вм)
	2. [Установка ОС на ВМ](#установка-ос-на-вм)
		1. [Установка Rocky Linux в графическом режиме](#установка-rocky-linux-в-графическом-режиме)
3. [Организация удалённого доступа к ВМ](#организация-удалённого-доступа-к-вм)
	1. [Первоначальная подготовка](#первоначальная-подготовка)
	2. [Первый способ генерации и копирования SSH ключей](#первый-способ-генерации-и-копирования-ssh-ключей)
		1. [Первый метод копирования SSH ключей](#первый-метод-копирования-ssh-ключей)
		2. [Второй метод копирования SSH ключей](#второй-метод-копирования-ssh-ключей)
	3. [Второй способ генерации и копирования SSH ключей](#второй-способ-генерации-и-копирования-ssh-ключей)

---

##### Цель работы:
>Получить навыки по работе с гипервизором, развертыванию виртуальной инфраструктуры, удаленному подключению к ВМ и настройке SSH ключей.

---

## Настройка гипервизора
>[!NOTE]
>Виртуальные машины широко применяются в среде разработки ПО для тестирования нового функционала без ущерба для производственного контура. Для создания новых и управления имеющимися ВМ используется программа, называемая гипервизором. Она позволяет выделить ресурсы компьютера-хоста и отдать их в распоряжение операционной системы виртуальной машины. На рынке представлено несколько продуктов от разных производителей, в данной работе выбор был сделан в пользу гипервизора Workstation компании VMware.

После установки гипервизора (данный этап был описан здесь: [Подготовка к лабораторным работам](Preparation_for_labs.md/#установка-vmware-workstation-pro)) на вашем ПК будут доступны следующие программы:

- Command Prompt for vctl – утилита командной строки VMware для управления контейнерами (нам она не пригодится);
- Virtual Network Editor – средство настройки виртуальных сетей;
- VMware Workstation 17 Player – программа для запуска ВМ;
- VMware Workstation Pro – гипервизор.

![Список установленных программ](../images/lab_1/1.0.png)

Перед началом работы непосредственно с гипервизором проверим настройки виртуальных сетей. Для этого откроем Virtual Network Editor с *правами администратора*, так как он вносит изменения в конфигурацию сетевых адаптеров хоста (в данных лабораторных в качестве него будет ваш ПК).

После открытия в верхней части окна можно увидеть таблицу с настроенными виртуальными сетями, а в нижней конфигурацию выбранной сети. По умолчанию преднастроено три сети разного типа:

- VMnet0 – сеть типа **мост** (bridged). Данный тип сетевого подключения создает прозрачный мост между интерфейсом ВМ и сетевым интерфейсом хоста. В его настройках лучше задать выбор интерфейса хоста статично, особенно в том случае, если на компьютере или ноутбуке несколько таких интерфейсов. Виртуальные машины, подключенные мостом, будут воспринимать сеть хоста так, будто они сами непосредственно подключены к ней.

![VMnet0](../images/lab_1/1.1.png)

- VMnet1 – сетевое подключение типа **внутренняя сеть** (host-only). Такая сеть объединяет подключенные к ней ВМ, но не предназначена для выхода в интернет. В настройках можно создать виртуальный сетевой адаптер для хоста в этой сети, таким образом организовав сетевое взаимодействие хоста и виртуальных машин в этой сети. Также можно настроить протокол DHCP для автоматического конфигурирования сетевых интерфейсов виртуальных машин.

![VMnet1](../images/lab_1/1.2.png)

- VMnet8 – сеть типа **NAT** (Network Address Translation). Данная сеть предназначена для доступа ВМ к глобальной сети, однако в случае отправки запроса во внешний мир производится подмена IP-адреса источника на IP-адрес активного интерфейса хоста. Внутри же сети узлы обмениваются информацией, используя недоступные глобально IP-адреса. Теперь в рамках настроек DHCP имеется возможность не только управлять стандартными параметрами выдачи IP-адресов, масок подсетей и шлюзов, но и настраивать правила NAT.

![VMnet8](../images/lab_1/1.3.png)

Давайте проверим присутствие соответствующих сетевых интерфейсов на хосте. В случае Windows проверить это можно, открыв PowerShell (оболочка командной строки Windows) и введя команду:

```powershell
Get-NetIPAddress -AddressFamily IPv4 -InterfaceAlias "VMware*" | Format-Table -Property InterfaceAlias, IPAddress
```

![Проверка существования сетевых интерфейсов](../images/lab_1/1.4.png)

Как видно на скрине выше, в системе присутствуют два виртуальных интерфейса из рассмотренных ранее сетей VMnet1 и VMnet8. Причем IP-адреса соответствуют диапазонам, указанным в настройках виртуальных сетей.

В данной работе необходимо обеспечить доступ ВМ в глобальную сеть, используя сетевые интерфейсы NAT или bridge.

---

## Установка виртуальной машины
### Создание новой ВМ
>[!NOTE]
>Виртуальные машины используют ресурсы хоста. Перед тем как создавать новые виртуальные машины, необходимо подумать о том, сколько ресурсов им потребуется, а также подготовить носители загрузочных образов операционных систем. Гипервизор позволяет смонтировать ISO-образ диска, физический дисковод или загрузочную флешку.

Для создания ВМ откроем гипервизор и воспользуемся кнопкой `Create a New Virtual Machine`, либо как продвинутые пользователи – комбинацией `Ctrl+N`.

![](../images/lab_1/1.5.png)

Дальше откроется окно конфигурации новой ВМ. В нём выбираем второй пункт (Custom), чтобы иметь возможность тонкой настройки нашей ВМ на этапе установки.

![](../images/lab_1/1.6.png)

Следующий пункт – настройка обратной совместимости с предыдущими версиями Workstation или ESXi (это промышленный гипервизор от VMware).

![](../images/lab_1/1.7.png)

Следующий шаг установки позволяет выбрать заранее подготовленный образ установочного диска. Если вдруг вы обнаружили, что дошли до этого шага, а образа под рукой нет (его можно установить с флешки, которую можно взять у преподавателя), то в этой работе использовался Rocky Linux, доступный для загрузки по [ссылке](https://rockylinux.org/download/).

![](../images/lab_1/1.8.png)

Потом можно указать название виртуальной машины и выбрать место размещения её файлов.

![](../images/lab_1/1.9.png)

Далее указываем количество используемых процессоров и ядер. Для этих работ большого количества ресурсов не понадобится, но и зажимать их не стоит.

![](../images/lab_1/1.10.png)

Также устанавливаем объём оперативной памяти для ВМ.

![](../images/lab_1/1.11.png)

Выберем вариант сетевых настроек. Следует использовать варианты, позволяющие получить доступ в интернет с виртуальной машины.

![](../images/lab_1/1.12.png)

В следующих двух шагах нужно выбрать тип SCSI-контроллера устройств ввода-вывода и тип жёсткого диска (лучше использовать рекомендуемые опции).

![](../images/lab_1/1.13.png)

![](../images/lab_1/1.14.png)

Создадим новый виртуальный жёсткий диск.

![](../images/lab_1/1.15.png)

Дальше укажем размер файла жёсткого диска и шаблон для имени этого файла:

![](../images/lab_1/1.16.png)

![](../images/lab_1/1.17.png)

Завершаем создание ВМ.

![](../images/lab_1/1.18.png)

После создания виртуальной машины она появится в списке слева, и станет доступна консоль управления ею:

![](../images/lab_1/1.19.png)

🎉 Поздравляю, первый шаг пройден!!!

### Установка ОС на ВМ
Если после создания ВМ не включилась автоматически, то для запуска следует выбрать пункт `Power on this virtual machine` с иконкой зелёного треугольника. После старта загрузится установщик операционной системы:

![](../images/lab_1/1.20.png)

#### Установка Rocky Linux в графическом режиме
>[!NOTE]
>В процессе установки имеется возможность установить дату и время, раскладку клавиатуры, источник установки ПО (репозиторий), разметку диска, сетевые настройки и не только. Порядок не важен за исключением выбора сетевого репозитория – его нужно подключить после предоставления ВМ доступа в сеть.

Выбираем язык (желательно выбирать *английский язык*, так как выдаваемый на нём отчёт об ошибке позволит найти более релевантные ресурсы в Гугле):

>[!WARNING]
>Если вместо графической оболочки установщика вы видите серый экран, то нужно:
>1. Остановить ВМ (к примеру нажатием комбинации клавиш `Ctrl+E`).
>2. Открыть настройки виртуальной машины.
>3. Перейти в пункт `Display`.
>4. Снять галочку напротив пункта `Accelerate 3D graphics`.

![](../images/lab_1/1.21.png)

Все настройки установки разбиты по группам. Пройдёмся по ним последовательно.

![](../images/lab_1/1.22.png)

Первая группа – ***Localization***. В ней можно выбрать настройки клавиатуры, поддержку языков локализации и часовой пояс:

![](../images/lab_1/1.23.png)

![](../images/lab_1/1.24.png)

![](../images/lab_1/1.25.png)

Следующая группа настроек – ***Software***. В ней можно выбрать, какие пакеты будут установлены, а также источник (зеркало или репозиторий), откуда эти пакеты будут загружены. 

В случае если был загружен образ minimal (Rocky-10.0-x86_64-minimal.iso), устанавливать операционную систему можно прямо с него. Если же был загружен образ boot (Rocky-10.0-x86_64-boot.iso), то необходимо задать сетевой источник загрузки. Проверить, какой образ используете именно вы, можно в настройках виртуальной машины:

![](../images/lab_1/1.26.png)

В данном случае ОС устанавливается с образа minimal, поэтому в разделе **Installation Source** выберем `Auto-detected installation source`. При использовании boot можно выбрать пункт `On the network` и `Closest mirror`, или указать предпочитаемый источник, но если на данном этапе не настроена сеть, то проверка выбранного источника провалится и возникнет ошибка.

![](../images/lab_1/1.27.png)

В любом случае в разделе **Software Selection** из всех предложенных вариантов следует выбрать минимальную установку, т.к. все необходимые программы будут установлены нами самостоятельно.

В случае установки с диска без добавления внешних репозиториев окно выбора может выглядеть как на скриншоте ниже. В правом столбце важно выбрать пункт `Standard`, он включает в себя архиватор **tar**, который потребуется для запуска серверной части Visual Studio Code.

![](../images/lab_1/1.28.png)

Следующая группа настроек – ***System***. В ней можно выбрать параметры дисковой и сетевой подсистем, kdump и профили безопасности.

В разделе **Installation Destination** (Расположение установки) необходимо произвести разметку диска. Чтобы иметь возможность управлять разделами, следует выбрать пункт `Custom`, после чего можно выбрать автоматическое разбиение и исправить его в случае необходимости.

![](../images/lab_1/1.29.png)

Для перехода к **Manual Partitioning** нужно нажать `Done`.

![](../images/lab_1/1.30.png)

![](../images/lab_1/1.31.png)

В конце можно ознакомиться со списком вносимых изменений и принять их. На этом работа с диском завершена.

![](../images/lab_1/1.32.png)

Следующим в настройке идёт **KDUMP**, в котором нам нужно отключить (вот так совпадение) kdump.

![](../images/lab_1/1.33.png)

В разделе **Network & Host Name** (Сеть и имя узла) можно настроить сеть. Если на этапе создания ВМ выбран тип интерфейса NAT и в настройках виртуальной сети включен DHCP-сервер, то в параметрах IPv4 сетевого адаптера следует выбрать автоматический метод получения сетевых настроек. Если выбран режим bridge и в сети хоста развернут сервер DHCP, также следует выбрать автоматический метод получения сетевых настроек. В других случаях необходимо статически назначить IP-адрес, маску подсети и другие сетевые настройки.

![](../images/lab_1/1.34.png)

![](../images/lab_1/1.35.png)

После того как интерфейс включен и ему присвоен IP-адрес, можно проверить доступность виртуальной машины с хоста. Для этого откроем PowerShell и введём команду (*используйте IP-адрес вашей ВМ!*):

```powershell
ping 192.168.243.128
```

![](../images/lab_1/1.36.png)

Следующая и последняя группа настроек – ***User Settings***. Она отвечает за настройку учётных записей root и пользователя. Это важный шаг, *пароли рекомендуется записать*.

В разделе **Root Account** опция `Allow root SSH login with password` разрешает удаленное подключение к виртуальной машине по протоколу SSH под учётной записью root. Эта практика не считается безопасной. Далее будет показано, как настроить логин по ключам без использования паролей, что является более безопасным решением.

![](../images/lab_1/1.37.png)

В самой нижней части интерфейса инсталляционного меню притаился ещё один пункт – **User Creation**. Он позволит создать нового пользователя, под которым и будут осуществляться все дальнейшие действия. 

Создадим нового пользователя, не забыв сделать его администратором. В качестве имени пользователя *используем собственную фамилию и инициалы* (как пример: PetrovEV), а все дальнейшие действия будут выполняться от имени этого пользователя. Опция `Add administrative privileges to this account` позволяет создаваемой учётной записи выполнять команды от имени суперпользователя, что потребуется при установке пакетов программного обеспечения и работы с системными сервисами.

![](../images/lab_1/1.38.png)

Ну а теперь можно приступать к установке. Нажимаем `Begin Installation`. 

![](../images/lab_1/1.39.png)

Ждём завершения установки и перезагружаем ВМ кнопкой `Reboot System`.

![](../images/lab_1/1.40.png)

![](../images/lab_1/1.41.png)

На данном этапе у нас есть виртуальная машина с доступом в интернет и развернутой ОС Rocky Linux. Дальше только интереснее!

---

## Организация удалённого доступа к ВМ
### Первоначальная подготовка
>[!NOTE]
>После установки ОС для взаимодействия с ней по сети необходимо настроить IP-адрес вручную или узнать, какой был присвоен динамически. Узнав его, мы сможем удалённо подключаться к консоли по протоколу SSH, загружать файлы по SFTP и/или SCP, установить и использовать различные сервисы и приложения.

IP-адрес мы настраивали или получали в процессе установки. Однако он может измениться в зависимости от сети, к которой подключена виртуальная машина. Узнаем IP-адрес сетевого интерфейса ВМ, для этого введём в консоль виртуальной машины команду:

```bash
ip --br a
```

![](../images/lab_1/1.42.png)

Как видно из ответа системы, IP-адрес устройства – 192.168.243.128 (/24 – это префикс, не является частью IP-адреса).

Подключиться к виртуальной машине можно прямо из терминала Windows введя:

```powershell
ssh batman@192.168.243.128
```

![](../images/lab_1/1.43.png)

Но при разработке удобнее подключаться к виртуальной машине, используя редактор Visual Studio Code. При помощи него можно удобно редактировать файлы на удалённом сервере, одновременно получая доступ к терминалу и файловой системе, и именно его мы будем использовать дальше в работах.

Для подключения к виртуальной машине необходимо установить плагин Remote SSH (данный процесс описан [здесь](Preparation_for_labs.md/#установка-vs-code-и-расширений))

Добавить новое подключение можно во вкладке **Remote Explorer**, нажав на `+`:

![](../images/lab_1/1.44.png)

После этого откроется строка для ввода команды подключения, вводим в неё команду с своей учётной записью и IP-адресом ВМ:

```bash
ssh batman@192.168.243.128 -A
```

![](../images/lab_1/1.45.png)

После ввода команды и нажатия `Enter` нам предложат выбрать конфигурационный файл, в который будут записаны параметры подключения. Соглашаемся с предложенным вариантом.

![](../images/lab_1/1.46.png)

В списке SSH появится новая запись с IP-адресом виртуальной машины. Конфигурационный файл со всеми записями можно открыть и отредактировать, нажав на `⚙️`:

![](../images/lab_1/1.47.png)

Подключение к узлу можно осуществить в текущем или новом окне VS Code.

![](../images/lab_1/1.48.png)

При первом подключении будет предложено выбрать ОС удалённого устройства и подтвердить его отпечаток.

![](../images/lab_1/1.49.png)

Если подключение так и не произошло, а VS Code выдаёт ошибку как на скрине ниже, то на ВМ стоит установить **tar** – программу, позволяющую работать с архивами. Ошибка вызвана тем, что на виртуальной машине требуется распаковать серверную часть VS Code.

![](../images/lab_1/1.50.png)

Исправим эту ситуацию, подключившись по SSH через терминал Windows и использовав команду:

```bash
sudo dnf install tar
```

![](../images/lab_1/1.51.png)

После чего успешно подключаемся к ВМ из VS Code!

![](../images/lab_1/1.52.png)

Статус подключения можно увидеть в левом нижнем углу, там должен отображаться протокол и IP-адрес узла:

![](../images/lab_1/1.53.png)

>[!NOTE]
>Кстати, подключаться по SSH можно не только через Visual Studio Code. Использование того или иного программного обеспечения – личной выбор каждого. Можно использовать любой другой эмулятор терминала, например, один из популярных – [PuTTY](https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html).
>
>А для удобного перемещения файлов по протоколам FTP, SFTP и SCP можно использовать различные файловые менеджеры, например, [WinSCP](https://winscp.net/eng/download.php).

Тем не менее, вне зависимости от выбранного способа подключения, наблюдается проблема – при открытии других директорий и сохранении файлов каждый раз будет запрашиваться пароль пользователя, что порядком утомляет. Существует несколько разных способов авторизовать пользователя при входе, одним из которых является авторизация по SSH ключам.

### Первый способ генерации и копирования SSH ключей
>[!NOTE]
>Пары ключей SSH представляют собой два ключа асимметричного алгоритма шифрования, которые можно использовать для аутентификации клиента на сервере SSH. Каждая пара ключей состоит из открытого ключа и закрытого ключа. Закрытый ключ хранится клиентом и должен быть абсолютно защищен. Соответствующий открытый ключ можно свободно передавать, не опасаясь негативных последствий. Открытый ключ можно использовать для шифрования сообщений, которые можно расшифровать только с помощью закрытого ключа.
>
>Открытый ключ выгружается на удалённый сервер, на который вы хотите заходить, используя SSH. Этот ключ добавляется в специальный файл `~/.ssh/authorized_keys` в учётной записи пользователя, которую вы используете для входа.

Есть несколько вариантов, где можно создать ключи. Первый вариант – создать ключи непосредственно на хосте и потом скопировать открытый ключ на удалённое устройство.

Для этого в PowerShell введём команду:

```powershell
ssh-keygen -t ed25519
```

![](../images/lab_1/1.54.png)

Следует обратить внимание на то, куда сохранены открытый и закрытый ключи. По умолчанию ключи хранятся в каталоге `~/.ssh` внутри домашнего каталога вашего пользователя. Закрытый ключ будет иметь имя **id_ed25519**, а соответствующий открытый ключ будет иметь имя **id_ed25519.pub**.

![](../images/lab_1/1.55.png)

Чтобы сервер SSH на ВМ с Linux мог авторизовать наше подключение, на сервер необходимо скопировать открытый ключ. Его содержимое необходимо поместить в файл `~/.ssh/authorized_keys`, как упоминалось ранее. 

Используемый метод копирования в основном зависит от доступных инструментов и от деталей текущей конфигурации. Следующие методы дают один и тот же конечный результат.

#### Первый метод копирования SSH ключей
**Первый метод** – подставить вручную путь к открытому ключу, имя пользователя и IP-адрес в команду:

```powershell
ssh batman@192.168.243.128 "mkdir -p ~/.ssh"
```

```powershell
scp "C:\Users\User/.ssh/id_ed25519.pub" batman@192.168.243.128:~/.ssh/authorized_keys
```

```powershell
ssh batman@192.168.243.128 "chmod 700 ~/.ssh && chmod 600 ~/.ssh/authorized_keys"
```

![](../images/lab_1/1.56.png)

#### Второй метод копирования SSH ключей
**Второй метод** – создать переменные и воспользоваться командлетами PowerShell ([пример](https://code.visualstudio.com/docs/remote/troubleshooting)):

```powershell
$USER_AT_HOST="batman@192.168.243.128"
```

```powershell
$PUBKEYPATH="C:\Users\User/.ssh/id_ed25519.pub"
```

```powershell
$pubKey=(Get-Content "$PUBKEYPATH" | Out-String); ssh "$USER_AT_HOST" "mkdir -p ~/.ssh && chmod 700 ~/.ssh && echo '${pubKey}' >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys"
```

![](../images/lab_1/1.57.png)

### Второй способ генерации и копирования SSH ключей
Однако есть второй вариант генерации ключей и доставки их на сервер – воспользоваться WSL (Windows Subsystem for Linux). Установка WSL займёт непродолжительное время, однако окажется крайне полезной впоследствии (не только в рамках данных работ).

Узнать список дистрибутивов можно командой:

```powershell
wsl -l -o
```

![](../images/lab_1/1.58.png)

Установим:

```powershell
wsl --install -d Ubuntu
```

![](../images/lab_1/1.59.png)

![](../images/lab_1/1.60.png)

```powershell
wsl --install Ubuntu-24.04
```

Возможно, потребуется перезагрузка, об этом будет сказано в процессе установки. После перезагрузки можно увидеть окно установки Ubuntu:

![](../images/lab_1/1.61.png)

Если его закрыть, не заполняя имя пользователя, то при подключении к WSL попадём туда с учётной записью root.

Подключиться к WSL можно при помощи VS Code, потребуется установить плагин WSL:

![](../images/lab_1/1.62.png)

![](../images/lab_1/1.63.png)

![](../images/lab_1/1.64.png)

Сгенерируем ключи знакомой командой:

```bash
ssh-keygen -t ed25519
```

![](../images/lab_1/1.65.png)

Теперь немного магии. Файловая система Windows доступна в WSL в каталоге `/mnt`.

![](../images/lab_1/1.66.png)

Таким образом, папка с SSH-ключами пользователя `C:\Users\username\.ssh` будет доступна по пути `/mnt/c/Users/username/.ssh`. Скопируем сгенерированные ключи из папки пользователя Windows:

```bash
cp -v .ssh/id_ed25519* /mnt/c/Users/User/.ssh/
```

![](../images/lab_1/1.67.png)

Добавить ключ на ВМ из WSL можно командой:

```bash
ssh-copy-id batman@192.168.243.128
```

![](../images/lab_1/1.68.png)

---

Если все сделано правильно, то подключение к виртуальной машине произойдёт без ввода пароля в терминале Windows:

![](../images/lab_1/1.69.png)

Так и в VS Code:

![](../images/lab_1/1.70.png)

Поздравляю, первая лабораторная сделана!!!